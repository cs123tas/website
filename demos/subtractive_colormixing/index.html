<!DOCTYPE html>
<html lang="en">
<head>
  <title>Subtractive Colormixing</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="index.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>

  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Canvases
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li><a href="#" onclick="changeCanvas()">CMY Colorfield</a></li>
      <li><a href="#" onclick="changePaintCanvas()">Paint Canvas</a></li>
    </ul>
  </div>

<br>
<div class="container">
  <div class="row">
    <div class="col-sm-9" id="app">
    <canvas id="canvas"></canvas>
    </div>
    <div class="col-sm-3">
      <h3>Color Components</h3>
      <div class="container" id="bars">
      <div class="col-sm-3" id="cyanBar">
      	<div id="cyanColored"></div>
      	C
      </div>
      <div class="col-sm-3" id="magentaBar">
      	<div id="magentaColored"></div>
      	M
      </div>
      <div class="col-sm-3" id="yellowBar">
      	<div id="yellowColored"></div>
      	Y
      </div>
      <div class="col-sm-3" id="blackBar">
      	<div id="blackColored"></div>
      	B
      </div>
      </div>
      <div id="radio">
      	<input type="radio" name="colormode" value="cmy" onchange="updateCMYMode()"/>cmy
      	<input type="radio" name="colormode" value="cmyk" onchange="updateCMYMode()"/>cmyk
      </div>
      <br>
      <h3>Color Selector</h3>
     <button onclick="changeCyan()" id="cyan">
     	<img src="images/cyanBottleClosed.gif">
     </button>
     <button onclick="changeMagenta()" id="magenta">
     	<img src="images/magentaBottleClosed.gif">
     </button>
     <button onclick="changeYellow()" id="yellow">
     	<img src="images/yellowBottleClosed.gif">
     </button>
      <button onclick="changeBlack()" id="black">
     	<img src="images/blackBottleClosed.gif">
     </button>
      <h3>Alpha</h3>
      <input type="number" min="0" max="1.0" step="0.01" value="0.5" id="alphaNumber">
      <input type="range" min="0" max="1.0" step="0.01" value="0.5" class="slider" onchange="updateAlpha(this.value)" id="alphaSlider">
    </div>
  </div>
</div>
</body>
<script>


 	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
 	var painting = document.getElementById('paint');
 	var windowoffset = window.innerWidth / 8;
  	var width = window.innerWidth - 4 * windowoffset;
  	var height = window.innerHeight - windowoffset;
  	// if(width < 800) {
  	// 	width = 800;
  	// }
  	// if(height < 600) {
  	// 	height = 600;
  	// }
	canvas.width = width;
	canvas.height = height;
	canvas.style.border = '1px solid #000';

	var mouse = {x: 0, y: 0};

	ctx.fillStyle = "white";
	ctx.fillRect(0, 0, canvas.width, canvas.height);

	canvas.addEventListener('mousemove', function(e) {
		mouse = getMousePos(canvas, e);
		var data = ctx.getImageData(mouse.x, mouse.y, 1, 1).data;
		var red = data[0];
		var green = data[1];
		var blue = data[2];
		var alpha = data[3];

	    if(red == null) {
	    	red = 255;
	    }
	    if(green == null) {
	    	green = 255;
	    }
	    if(blue == null) {
	    	blue = 255;
	    }

	    var cyanBar = document.getElementById('cyanColored');
		var magentaBar = document.getElementById('magentaColored');
	    var yellowBar = document.getElementById('yellowColored');
	    var blackBar = document.getElementById('blackColored');

	    var colors = null;
	    if(!cmy) {
			colors = rgb2cmyk(red, green, blue);
			// BLACK
			var blackPercent = colors[3] * 100;
			blackBar.style.height = blackPercent + "%";
	    } else {
	    	colors = rgb2cmy(red, green, blue);
	    }

	    // CYAN
	    var cyanPercent = colors[0] * 100;
		cyanBar.style.height = cyanPercent + "%";

	    // MAGENTA
	    var magentaPercent = colors[1] * 100;
		magentaBar.style.height = magentaPercent + "%";

	    // YELLOW
	    var yellowPercent = colors[2] * 100;
		yellowBar.style.height = yellowPercent + "%";

	} , false);

	var img = new Image();
	img.src = "images/cymkColorfieldBackground.jpg";
	img.onload = function () {
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		var imgWidth = canvas.width * 0.5;
		var imgHeight = canvas.height * 0.4;
    	ctx.drawImage(img,canvas.width / 4,canvas.height / 4, imgWidth, imgHeight);
	};

	function getMousePos(canvas, e) {
		var rect = canvas.getBoundingClientRect();
		return {
			x: e.clientX - rect.left,
			y: e.clientY - rect.top
		}
	}

	canvas.addEventListener('mousemove', function(e){
		mouse = getMousePos(canvas, e);
	}, false);

	var alpha = 0.5;
	var paintColor = 0;
	function updateAlpha(val) {
          document.getElementById('alphaNumber').value=val;
          alpha = val;

          switch(paintColor) {
          	case 0:
          		changeCyan();
          		break;

          	case 1:
          		changeMagenta();
          		break;

          	case 2:
          		changeYellow();
          		break;

          	case 3:
          		changeBlack();
          		break;

          	default:
          		break;
          }
    }

    var cmy = true;
    function updateCMYMode() {
    	var modes = document.getElementsByName('colormode');
    	if(modes[0].checked) {
    		cmy = true;
    	} else {
    		cmy = false;
    	}
    }

var lastMouse = mouse;
var storedStrokes = [];
var curStroke = [];
var onPaint = function(e) {
		if(!colorField) {
	mouse = getMousePos(canvas, e);

	curStroke.push({x1:lastMouse.x, y1: lastMouse.y, x2: mouse.x, y2: mouse.y, style: ctx.strokeStyle});
	ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
	redrawStoredStrokes();
    redrawStroke(curStroke);

    lastMouse = mouse;
}
};

function redrawStoredStrokes(){
		for(var i = 0; i < storedStrokes.length; i++) {
			redrawStroke(storedStrokes[i]);
		}
}

function redrawStroke(stroke){

    if(stroke.length==0){ return; }

    ctx.globalCompositeOperation = 'darken';
    ctx.beginPath();
    // redraw each stored line
    for(var i=0;i<stroke.length;i++){
    	ctx.strokeStyle = stroke[i].style;
        ctx.moveTo(stroke[i].x1,stroke[i].y1);
        ctx.lineTo(stroke[i].x2,stroke[i].y2);
    }

    ctx.stroke();
}

var drawPaint = function(e) {
			mouse = getMousePos(canvas, e);
	    	lastMouse = mouse;
	    	ctx.beginPath();
			ctx.moveTo(lastMouse.x, lastMouse.y);
	    	canvas.addEventListener('mousemove', onPaint, false);
}

var stopPaint = function() {
		    canvas.removeEventListener('mousemove', onPaint, false);
		    storedStrokes.push(curStroke);
		    curStroke = [];
};



	function changeCyan(e) {
		ctx.strokeStyle = 'rgba(0,255,255,' + alpha +')';
		paintColor = 0;
	}

	function changeMagenta(e) {
		ctx.strokeStyle = 'rgba(255,0,255,' + alpha +')';
		paintColor = 1;
	}

	function changeYellow(e) {
		ctx.strokeStyle = 'rgba(255,255,0,' + alpha + ')';
		paintColor = 2;
	}

	function changeBlack(e) {
		ctx.strokeStyle = 'rgba(0,0,0,' + alpha + ')';
		paintColor = 3;
	}

var colorField = true;
var changeCanvas = function() {
	storedStrokes = [];
	    ctx.globalCompositeOperation = 'source-over';
		ctx.fillStyle = "white";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		var img = new Image();
		img.src = "images/cymkColorfieldBackground.jpg";
		img.onload = function () {
			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
	    	var imgWidth = canvas.width * 0.5;
			var imgHeight = canvas.height * 0.4;
    		ctx.drawImage(img,canvas.width / 4,canvas.height / 4, imgWidth, imgHeight);

		};
		colorField = true;
};

var changePaintCanvas = function() {
	storedStrokes = [];
		ctx.fillStyle = "white";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		ctx.lineWidth = 30;
		ctx.lineJoin = 'round';
		ctx.lineCap = 'round';
		ctx.strokeStyle = 'rgba(0,255,255,' + alpha + ')';
		canvas.addEventListener('mousedown', drawPaint, false);
		canvas.addEventListener('mouseup', stopPaint, false);
		colorField = false;
};


function rgb2cmy(r,g,b) {
	var c = 0;
	var m = 0;
	var k = 0;

 c = 1 - (r/255.0);
 m = 1 - (g/255.0);
 y = 1 - (b/255.0);

 return [c, m, y];
}

function rgb2cmyk (r,g,b) {
 var computedC = 0;
 var computedM = 0;
 var computedY = 0;
 var computedK = 0;

 // BLACK
 if (r==0 && g==0 && b==0) {
  computedK = 1;
  return [0,0,0,1];
 }

 computedC = 1 - (r/255);
 computedM = 1 - (g/255);
 computedY = 1 - (b/255);

 var minCMY = Math.min(computedC,
              Math.min(computedM,computedY));
 computedC = (computedC - minCMY) / (1 - minCMY) ;
 computedM = (computedM - minCMY) / (1 - minCMY) ;
 computedY = (computedY - minCMY) / (1 - minCMY) ;
 computedK = minCMY;

 return [computedC,computedM,computedY,computedK];
}

 </script>
</html>
